<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MAXIS STRIKE v5.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:none}
body{background:#000;overflow:hidden;font-family:'Segoe UI',sans-serif;color:#fff}
canvas{display:block}

/* MENU */
#menu{position:fixed;inset:0;z-index:100;background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#0a0a0a);display:flex;flex-direction:column;align-items:center;justify-content:center}
#menu.hidden{display:none}
.logo-main{font-size:64px;font-weight:900;background:linear-gradient(180deg,#fff,#ff6600,#cc3300);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:6px;text-shadow:0 0 30px rgba(255,100,0,0.3)}
.logo-sub{font-size:14px;color:#ff6600;letter-spacing:8px;margin-bottom:40px}
.menu-buttons{display:flex;flex-direction:column;gap:8px;min-width:300px}
.menu-btn{background:linear-gradient(90deg,rgba(255,102,0,0),rgba(255,102,0,0.1),rgba(255,102,0,0));border:none;border-left:2px solid transparent;color:#ccc;font-size:16px;padding:14px 40px;cursor:pointer;text-transform:uppercase;letter-spacing:4px;text-align:left;transition:all 0.2s}
.menu-btn:hover{background:linear-gradient(90deg,rgba(255,102,0,0.2),rgba(255,102,0,0.05));color:#ff6600;border-left:2px solid #ff6600}

/* SERVER BROWSER */
#serverBrowser{position:fixed;inset:0;z-index:110;background:rgba(0,0,0,0.95);display:none;flex-direction:column;align-items:center;padding:20px;overflow-y:auto}
#serverBrowser.show{display:flex}
.browser-header{font-size:28px;color:#ff6600;letter-spacing:6px;margin-bottom:20px}
.browser-content{display:flex;gap:20px;width:100%;max-width:1200px;flex-wrap:wrap;justify-content:center}
.server-list-panel{flex:1;min-width:400px;max-width:600px;background:#111;border:1px solid #333}
.server-list-header{background:#1a1a1a;padding:12px 20px;font-size:12px;color:#888;display:grid;grid-template-columns:2fr 1fr 1fr 80px;border-bottom:1px solid #333}
.server-list{max-height:400px;overflow-y:auto}
.server-item{display:grid;grid-template-columns:2fr 1fr 1fr 80px;padding:12px 20px;border-bottom:1px solid #222;cursor:pointer;transition:all 0.2s}
.server-item:hover{background:#1a1a1a}
.server-item.selected{background:#2a2a1a;border-left:3px solid #ff6600}
.server-item .name{color:#fff;display:flex;align-items:center;gap:8px}
.server-item .lock{color:#ff6600;font-size:10px}
.server-item .map{color:#888}
.server-item .mode{color:#6cf;font-size:12px}
.server-item .players{color:#0f0}
.no-servers{padding:40px;text-align:center;color:#666}
.create-panel{width:350px;background:#111;border:1px solid #333;padding:25px}
.create-panel h3{font-size:16px;color:#ff6600;margin-bottom:20px;letter-spacing:3px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:11px;color:#888;margin-bottom:6px;letter-spacing:2px;text-transform:uppercase}
.form-group input[type=text],.form-group input[type=password]{width:100%;background:#0a0a0a;border:1px solid #333;color:#fff;padding:10px 12px;font-size:14px;outline:none}
.form-group input:focus{border-color:#ff6600}
.map-selector{display:flex;gap:8px;flex-wrap:wrap}
.map-option{flex:1;min-width:100px;background:#0a0a0a;border:2px solid #333;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.map-option:hover{border-color:#666}
.map-option.selected{border-color:#ff6600;background:#1a1a0a}
.map-option .map-name{font-size:12px;color:#fff}
.map-option .map-desc{font-size:9px;color:#666;margin-top:4px}
.mode-selector{display:flex;flex-direction:column;gap:8px}
.mode-option{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#0a0a0a;border:2px solid #333;cursor:pointer;transition:all 0.2s}
.mode-option:hover{border-color:#666}
.mode-option.selected{border-color:#ff6600;background:#1a1a0a}
.mode-option .mode-icon{font-size:18px}
.mode-option .mode-name{font-size:13px;color:#fff}
.create-btn{margin-top:20px;width:100%;background:linear-gradient(180deg,#ff6600,#cc3300);border:none;color:#fff;padding:14px;font-size:14px;letter-spacing:3px;cursor:pointer;transition:all 0.2s}
.create-btn:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(255,100,0,0.3)}
.browser-actions{display:flex;gap:15px;margin-top:25px}
.action-btn{background:#1a1a1a;border:1px solid #333;color:#888;padding:12px 30px;font-size:13px;letter-spacing:2px;cursor:pointer;transition:all 0.2s}
.action-btn:hover{border-color:#ff6600;color:#ff6600}
.action-btn.primary{background:#ff6600;border-color:#ff6600;color:#fff}
.action-btn.primary:hover{background:#ff8833}
.action-btn:disabled{opacity:0.5;cursor:not-allowed}

/* PASSWORD PROMPT */
#passwordPrompt{position:fixed;inset:0;z-index:120;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center}
#passwordPrompt.show{display:flex}
.password-box{background:#111;border:1px solid #333;padding:30px;min-width:300px}
.password-box h3{color:#ff6600;margin-bottom:20px}
.password-box input{width:100%;background:#0a0a0a;border:1px solid #333;color:#fff;padding:12px;margin-bottom:15px;outline:none}
.password-box .btns{display:flex;gap:10px}

/* SETTINGS */
#settingsPanel{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;overflow-y:auto}
#settingsPanel.show{display:flex}
.settings-box{background:#111;border:1px solid #222;padding:40px;min-width:400px;max-width:600px}
.settings-box h2{font-size:20px;color:#ff6600;margin-bottom:25px;letter-spacing:4px}
.setting-row{margin-bottom:18px}
.setting-row label{display:block;font-size:12px;color:#888;margin-bottom:6px;letter-spacing:2px;text-transform:uppercase}
.setting-row input[type=text],.setting-row input[type=number]{width:100%;background:#0a0a0a;border:1px solid #333;color:#fff;padding:10px;font-size:14px;outline:none}
.setting-row input:focus{border-color:#ff6600}
.setting-row input[type=range]{width:100%;accent-color:#ff6600}
.settings-back{margin-top:20px;background:none;border:1px solid #333;color:#888;padding:10px 30px;cursor:pointer;font-size:13px;letter-spacing:2px;transition:all 0.2s}
.settings-back:hover{border-color:#ff6600;color:#ff6600}
.crosshair-selector,.skin-selector{display:flex;gap:10px;margin-top:10px}
.crosshair-preview,.skin-option{width:40px;height:40px;border:2px solid #333;cursor:pointer;display:flex;align-items:center;justify-content:center}
.crosshair-preview:hover,.skin-option:hover{border-color:#666}
.crosshair-preview.selected,.skin-option.selected{border-color:#ff6600}
.skin-1{background:linear-gradient(135deg,#8B4513,#654321)}
.skin-2{background:linear-gradient(135deg,#2F4F4F,#1a3a3a)}
.skin-3{background:linear-gradient(135deg,#8B0000,#4a0000)}

/* HUD */
#hud{position:fixed;inset:0;z-index:50;pointer-events:none}
#hud.hidden{display:none}
.crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.crosshair div{position:absolute;background:#0f0}
.ch-top{width:2px;height:10px;left:-1px;top:-16px}
.ch-bot{width:2px;height:10px;left:-1px;top:6px}
.ch-left{width:10px;height:2px;left:-16px;top:-1px}
.ch-right{width:10px;height:2px;left:6px;top:-1px}
.ch-dot{width:2px;height:2px;left:-1px;top:-1px;background:rgba(0,255,0,0.5)}
.crosshair.style-dot .ch-top,.crosshair.style-dot .ch-bot,.crosshair.style-dot .ch-left,.crosshair.style-dot .ch-right{display:none}
.crosshair.style-dot .ch-dot{width:4px;height:4px;left:-2px;top:-2px;border-radius:50%}
.crosshair.style-circle .ch-top,.crosshair.style-circle .ch-bot,.crosshair.style-circle .ch-left,.crosshair.style-circle .ch-right{display:none}
.crosshair.style-circle .ch-dot{width:16px;height:16px;left:-8px;top:-8px;border-radius:50%;border:2px solid #0f0;background:none}

.hp-bar{position:absolute;bottom:20px;left:20px;display:flex;align-items:center;gap:12px}
.hp-icon{font-size:28px}
.hp-num{font-size:32px;font-weight:700}
.hp-num.low{color:#ff3333}
.hp-num.mid{color:#ffaa00}
.hp-num.ok{color:#fff}

.money-display{position:absolute;bottom:60px;left:20px;font-size:24px;color:#0f0;font-weight:bold}

.ammo-bar{position:absolute;bottom:20px;right:20px;display:flex;align-items:baseline;gap:6px}
.ammo-bar.hidden{display:none}
.ammo-clip{font-size:32px;font-weight:700}
.ammo-sep{font-size:20px;color:#666}
.ammo-total{font-size:18px;color:#888}
.weapon-name{position:absolute;bottom:60px;right:20px;font-size:12px;color:#666;letter-spacing:3px;text-transform:uppercase}

.team-indicator{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);font-size:14px;letter-spacing:3px;padding:6px 20px;background:rgba(0,0,0,0.6)}
.team-indicator.T{color:#ff8844;border-left:3px solid #ff6600}
.team-indicator.CT{color:#44aaff;border-left:3px solid #0066ff}

.scores-display{position:absolute;top:15px;left:50%;transform:translateX(-50%);display:flex;gap:30px;font-size:24px}
.score-t{color:#ff8844}
.score-ct{color:#44aaff}
.score-sep{color:#444}

.kill-feed{position:absolute;top:90px;right:10px;display:flex;flex-direction:column;gap:3px;align-items:flex-end}
.kill-entry{background:rgba(0,0,0,0.7);padding:4px 10px;font-size:12px;display:flex;gap:8px;align-items:center;animation:fadeKill 4s forwards;border-left:2px solid #ff6600}
@keyframes fadeKill{0%,70%{opacity:1}100%{opacity:0}}
.kill-entry .killer{color:#ff6600}
.kill-entry .victim{color:#6cf}

.hit-marker{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;display:none}
.hit-marker.show{display:block;animation:hmPop 0.2s}
@keyframes hmPop{0%{transform:translate(-50%,-50%) scale(1.5);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:0.8}}
.hm-line{position:absolute;background:#fff}
.hm-1{width:12px;height:2px;transform:rotate(45deg);left:4px;top:-2px}
.hm-2{width:12px;height:2px;transform:rotate(-45deg);left:4px;top:10px}
.hm-3{width:12px;height:2px;transform:rotate(135deg);left:-6px;top:-2px}
.hm-4{width:12px;height:2px;transform:rotate(-135deg);left:-6px;top:10px}

.dmg-overlay{position:fixed;inset:0;pointer-events:none;z-index:45;border:3px solid transparent;transition:border-color 0.1s}
.dmg-overlay.hit{border-color:rgba(255,0,0,0.6)}

.death-screen{position:fixed;inset:0;z-index:60;background:rgba(100,0,0,0.5);display:none;align-items:center;justify-content:center;flex-direction:column}
.death-screen.show{display:flex}
.death-screen h2{font-size:36px;color:#ff3333}
.death-screen p{color:#999;margin-top:10px;font-size:14px}

.muzzle-flash{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;border-radius:50%;background:radial-gradient(circle,rgba(255,200,50,0.8),transparent);display:none;pointer-events:none}
.muzzle-flash.show{display:block;animation:flash 0.05s}
@keyframes flash{0%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}100%{opacity:0}}

/* RADAR */
.radar{position:absolute;top:15px;left:15px;width:140px;height:140px;background:rgba(0,20,0,0.7);border:1px solid #1a3a1a;border-radius:4px;overflow:hidden}
.radar-center{position:absolute;top:50%;left:50%;width:4px;height:4px;background:#0f0;border-radius:50%;transform:translate(-50%,-50%);z-index:2}
.radar canvas{position:absolute;inset:0}

.conn-status{position:absolute;top:15px;left:170px;font-size:11px;letter-spacing:2px;padding:4px 12px;background:rgba(0,0,0,0.6)}
.conn-status.ok{color:#0f0}
.conn-status.err{color:#f33}

/* BUY ZONE INDICATOR */
.buy-zone-indicator{position:absolute;top:170px;left:15px;font-size:12px;color:#0f0;padding:6px 12px;background:rgba(0,50,0,0.7);border:1px solid #0f0;display:none}
.buy-zone-indicator.show{display:block}

/* SHOP */
#shopPanel{position:fixed;inset:0;z-index:80;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center}
#shopPanel.show{display:flex}
.shop-box{background:#111;border:1px solid #333;padding:30px;min-width:500px}
.shop-box h2{font-size:20px;color:#ff6600;margin-bottom:20px;letter-spacing:4px}
.shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.shop-item{background:#1a1a1a;border:2px solid #333;padding:15px;text-align:center;cursor:pointer;transition:all 0.2s}
.shop-item:hover{border-color:#ff6600}
.shop-item.owned{border-color:#0f0;background:#0a1a0a}
.shop-item.cant-afford{opacity:0.5}
.shop-item .weapon-icon{font-size:32px;margin-bottom:10px}
.shop-item .weapon-name{font-size:14px;color:#fff}
.shop-item .weapon-price{font-size:12px;color:#0f0;margin-top:5px}
.shop-close{margin-top:20px;background:none;border:1px solid #333;color:#888;padding:10px 30px;cursor:pointer}
.shop-close:hover{border-color:#ff6600;color:#ff6600}
.shop-money{font-size:18px;color:#0f0;margin-bottom:15px}

/* SCOREBOARD */
#scoreboard{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:80;display:none;min-width:500px;background:rgba(0,0,0,0.92);border:1px solid #333}
#scoreboard.show{display:block}
.sb-header{background:#111;padding:12px 20px;font-size:14px;color:#ff6600;letter-spacing:4px;border-bottom:1px solid #333}
.sb-table{width:100%;border-collapse:collapse}
.sb-table th{text-align:left;padding:8px 15px;font-size:11px;color:#666;border-bottom:1px solid #222;letter-spacing:2px}
.sb-table td{padding:6px 15px;font-size:13px;border-bottom:1px solid #111}
.sb-table tr.me td{color:#ff6600}
.team-t{color:#f4a460}
.team-ct{color:#6ca6cd}

/* CHAT */
#chatBox{position:fixed;bottom:80px;left:20px;z-index:70;width:350px}
.chat-msgs{max-height:150px;overflow:hidden;display:flex;flex-direction:column;gap:2px;margin-bottom:5px}
.chat-msg{font-size:12px;background:rgba(0,0,0,0.5);padding:3px 8px;animation:fadeMsg 10s forwards}
@keyframes fadeMsg{0%,80%{opacity:1}100%{opacity:0}}
.chat-msg .cn{color:#ff6600}
.chat-msg .cn.team-t{color:#ff8844}
.chat-msg .cn.team-ct{color:#44aaff}
.chat-input{display:none;background:rgba(0,0,0,0.8);border:1px solid #333;color:#fff;padding:6px 10px;width:100%;font-size:13px;outline:none}
.chat-input.show{display:block;pointer-events:auto}

/* IN-GAME MENU */
#ingameMenu{position:fixed;inset:0;z-index:90;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px}
#ingameMenu.show{display:flex}
.ingame-btn{background:#1a1a1a;border:1px solid #333;color:#ccc;padding:12px 40px;font-size:14px;letter-spacing:3px;cursor:pointer;min-width:200px;text-align:center;transition:all 0.2s}
.ingame-btn:hover{border-color:#ff6600;color:#ff6600}

/* KILL CAM */
#killCam{position:fixed;inset:0;z-index:70;display:none;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;flex-direction:column}
#killCam.show{display:flex}
.kill-cam-title{font-size:24px;color:#ff3333;margin-bottom:10px}
.kill-cam-info{font-size:14px;color:#ccc;margin-bottom:20px}
.kill-cam-killer{color:#ff6600;font-weight:bold}
.kill-cam-weapon{color:#6cf}

/* DAMAGE INDICATOR */
#damageIndicator{position:fixed;inset:0;z-index:48;pointer-events:none;display:none}
#damageIndicator.show{display:block}
.damage-arrow{position:absolute;width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-bottom:40px solid rgba(255,0,0,0.6)}

/* BLOOD EFFECT */
#bloodEffect{position:fixed;inset:0;z-index:46;pointer-events:none;display:none;background:radial-gradient(circle,rgba(255,0,0,0.3) 0%,transparent 70%)}
#bloodEffect.show{display:block;animation:bloodFade 0.5s forwards}
@keyframes bloodFade{0%{opacity:1}100%{opacity:0}}

/* PARTICLES */
#particlesContainer{position:fixed;inset:0;z-index:44;pointer-events:none;overflow:hidden}
.particle{position:absolute;border-radius:50%;pointer-events:none}

/* ACHIEVEMENT POPUP */
#achievementPopup{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:180;display:none;background:rgba(0,100,0,0.9);border:2px solid #0f0;padding:15px 25px;text-align:center}
#achievementPopup.show{display:block;animation:achievementPop 0.5s ease-out}
@keyframes achievementPop{0%{transform:translateX(-50%) translateY(-100px);opacity:0}100%{transform:translateX(-50%) translateY(0);opacity:1}}
.ach-popup-icon{font-size:32px}
.ach-popup-name{font-size:16px;font-weight:bold;margin-top:5px}
.ach-popup-desc{font-size:12px;color:#ccc}

/* GIB EFFECT WARNING */
.gib-warning{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:200;background:rgba(255,0,0,0.8);padding:20px;font-size:18px;display:none}

/* MOBILE CONTROLS */
#mobileControls{position:fixed;inset:0;z-index:40;display:none;pointer-events:none}
#mobileControls.show{display:block}
.mobile-btn{position:absolute;width:60px;height:60px;background:rgba(255,102,0,0.3);border:2px solid rgba(255,102,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;pointer-events:auto;user-select:none}
.mobile-btn:active{background:rgba(255,102,0,0.5)}
.mobile-btn.small{width:50px;height:50px;font-size:16px}
.btn-left{bottom:100px;left:20px}
.btn-right{bottom:100px;left:90px}
.btn-forward{bottom:170px;left:55px}
.btn-back{bottom:30px;left:55px}
.btn-shoot{bottom:100px;right:20px;background:rgba(255,0,0,0.3);border-color:rgba(255,0,0,0.6)}
.btn-jump{bottom:170px;right:20px}
.btn-reload{bottom:100px;right:90px}
.btn-shop{bottom:30px;right:55px;background:rgba(0,255,0,0.3);border-color:rgba(0,255,0,0.6)}
#touchLook{position:absolute;top:0;left:0;width:100%;height:50%;pointer-events:auto;background:transparent}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu">
  <div class="logo-sub">â˜… TACTICAL SHOOTER â˜…</div>
  <div class="logo-main">MAXIS STRIKE</div>
  <div class="logo-sub" style="margin-top:10px">v5.0 â€” RPG + PHYSICS + DESTRUCTION</div>
  <div class="menu-buttons" style="margin-top:40px">
    <button class="menu-btn" onclick="showServerBrowser()">â–º PLAY</button>
    <button class="menu-btn" onclick="showSettings()">âš™ SETTINGS</button>
    <button class="menu-btn" onclick="showControls()">âŒ¨ CONTROLS</button>
    <button class="menu-btn" onclick="showAbout()">â„¹ ABOUT</button>
  </div>
</div>

<!-- SERVER BROWSER -->
<div id="serverBrowser">
  <div class="browser-header">ğŸ® SERVER BROWSER</div>
  <div class="browser-content">
    <div class="server-list-panel">
      <div class="server-list-header">
        <span>SERVER NAME</span><span>MAP</span><span>MODE</span><span>PLAYERS</span>
      </div>
      <div class="server-list" id="serverList">
        <div class="no-servers">No servers available. Create one!</div>
      </div>
    </div>
    <div class="create-panel">
      <h3>â• CREATE SERVER</h3>
      <div class="form-group">
        <label>Server Name</label>
        <input type="text" id="createName" value="My Server" maxlength="24">
      </div>
      <div class="form-group">
        <label>Password (optional)</label>
        <input type="password" id="createPassword" placeholder="Leave empty for public">
      </div>
      <div class="form-group">
        <label>Map</label>
        <div class="map-selector">
          <div class="map-option selected" data-map="MS_START" onclick="selectMap(this)">
            <div class="map-name">MS_START</div>
            <div class="map-desc">Arena</div>
          </div>
          <div class="map-option" data-map="MS_DUST" onclick="selectMap(this)">
            <div class="map-name">MS_DUST</div>
            <div class="map-desc">Desert</div>
          </div>
          <div class="map-option" data-map="MS_ARENA_BETA" onclick="selectMap(this)">
            <div class="map-name">MS_ARENA_BETA</div>
            <div class="map-desc">Destructible!</div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Game Mode</label>
        <div class="mode-selector">
          <div class="mode-option selected" data-mode="deathmatch" onclick="selectMode(this)">
            <span class="mode-icon">ğŸ’€</span>
            <div class="mode-name">Team Deathmatch</div>
          </div>
          <div class="mode-option" data-mode="hostage" onclick="selectMode(this)">
            <span class="mode-icon">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
            <div class="mode-name">Hostage Rescue</div>
          </div>
        </div>
      </div>
      <button class="create-btn" onclick="createServer()">CREATE SERVER</button>
    </div>
  </div>
  <div class="browser-actions">
    <button class="action-btn" onclick="refreshServers()">ğŸ”„ REFRESH</button>
    <button class="action-btn primary" id="joinBtn" onclick="joinSelectedServer()" disabled>JOIN SERVER</button>
    <button class="action-btn" onclick="hideServerBrowser()">â† BACK</button>
  </div>
</div>

<!-- PASSWORD PROMPT -->
<div id="passwordPrompt">
  <div class="password-box">
    <h3>ğŸ”’ PASSWORD REQUIRED</h3>
    <input type="password" id="joinPassword" placeholder="Enter server password">
    <div class="btns">
      <button class="action-btn primary" onclick="submitPassword()">JOIN</button>
      <button class="action-btn" onclick="hidePasswordPrompt()">CANCEL</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsPanel">
  <div class="settings-box">
    <h2>âš™ SETTINGS</h2>
    <div class="setting-row">
      <label>Player Name</label>
      <input type="text" id="playerName" value="Player" maxlength="16">
    </div>
    <div class="setting-row">
      <label>Sensitivity: <span id="sensVal">3.0</span></label>
      <input type="range" id="sensitivity" min="0.5" max="10" step="0.5" value="3" oninput="document.getElementById('sensVal').textContent=this.value">
    </div>
    <div class="setting-row">
      <label>FOV: <span id="fovVal">75</span></label>
      <input type="range" id="fovSetting" min="60" max="110" step="5" value="75" oninput="document.getElementById('fovVal').textContent=this.value">
    </div>
    <div class="setting-row">
      <label>Volume: <span id="volVal">50</span>%</label>
      <input type="range" id="volume" min="0" max="100" step="5" value="50" oninput="document.getElementById('volVal').textContent=this.value">
    </div>
    <div class="setting-row">
      <label>Crosshair Style</label>
      <div class="crosshair-selector">
        <div class="crosshair-preview selected" data-style="default" onclick="selectCrosshair(this)">+</div>
        <div class="crosshair-preview" data-style="dot" onclick="selectCrosshair(this)">â€¢</div>
        <div class="crosshair-preview" data-style="circle" onclick="selectCrosshair(this)">â—‹</div>
      </div>
    </div>
    <div class="setting-row">
      <label>Weapon Skin</label>
      <div class="skin-selector">
        <div class="skin-option skin-1 selected" data-skin="1" onclick="selectSkin(this)"></div>
        <div class="skin-option skin-2" data-skin="2" onclick="selectSkin(this)"></div>
        <div class="skin-option skin-3" data-skin="3" onclick="selectSkin(this)"></div>
      </div>
    </div>
    <div class="setting-row">
      <label>Mobile Controls</label>
      <button class="action-btn" onclick="toggleMobileControls()">Toggle Mobile UI</button>
    </div>
    <button class="settings-back" onclick="hideSettings()">â† BACK</button>
  </div>
</div>

<!-- HUD -->
<div id="hud" class="hidden">
  <div class="crosshair" id="crosshair">
    <div class="ch-top"></div><div class="ch-bot"></div>
    <div class="ch-left"></div><div class="ch-right"></div>
    <div class="ch-dot"></div>
  </div>
  <div class="scores-display">
    <span class="score-t" id="scoreT">0</span>
    <span class="score-sep">:</span>
    <span class="score-ct" id="scoreCT">0</span>
  </div>
  <div class="hp-bar">
    <span class="hp-icon">âœš</span>
    <span class="hp-num ok" id="hpNum">100</span>
  </div>
  <div class="money-display" id="moneyDisplay">$800</div>
  <div class="team-indicator T" id="teamIndicator">TERRORIST</div>
  <div class="ammo-bar" id="ammoBar">
    <span class="ammo-clip" id="ammoClip">30</span>
    <span class="ammo-sep">/</span>
    <span class="ammo-total" id="ammoTotal">90</span>
  </div>
  <div class="weapon-name" id="weaponName">KNIFE</div>
  <div class="kill-feed" id="killFeed"></div>
  <div class="hit-marker" id="hitMarker">
    <div class="hm-line hm-1"></div><div class="hm-line hm-2"></div>
    <div class="hm-line hm-3"></div><div class="hm-line hm-4"></div>
  </div>
  <div class="muzzle-flash" id="muzzleFlash"></div>
  <div class="radar"><canvas id="radarCanvas" width="140" height="140"></canvas><div class="radar-center"></div></div>
  <div class="conn-status ok" id="connStatus">CONNECTED</div>
  <div class="buy-zone-indicator" id="buyZoneIndicator">ğŸ›’ PRESS B TO BUY</div>
</div>

<!-- SHOP -->
<div id="shopPanel">
  <div class="shop-box">
    <h2>ğŸ›’ WEAPON SHOP</h2>
    <div class="shop-money">Your Money: $<span id="shopMoney">800</span></div>
    <div class="shop-grid" id="shopGrid"></div>
    <button class="shop-close" onclick="closeShop()">CLOSE (B)</button>
  </div>
</div>

<!-- MOBILE CONTROLS -->
<div id="mobileControls">
  <div id="touchLook"></div>
  <div class="mobile-btn btn-left" id="btnLeft">â—„</div>
  <div class="mobile-btn btn-right" id="btnRight">â–º</div>
  <div class="mobile-btn btn-forward" id="btnForward">â–²</div>
  <div class="mobile-btn btn-back" id="btnBack">â–¼</div>
  <div class="mobile-btn btn-shoot" id="btnShoot">ğŸ”«</div>
  <div class="mobile-btn btn-jump small" id="btnJump">â†‘</div>
  <div class="mobile-btn btn-reload small" id="btnReload">R</div>
  <div class="mobile-btn btn-shop small" id="btnShop">B</div>
</div>

<!-- EFFECTS -->
<div class="dmg-overlay" id="dmgOverlay"></div>
<div id="bloodEffect"></div>
<div id="damageIndicator"></div>
<div id="particlesContainer"></div>

<!-- DEATH SCREEN -->
<div class="death-screen" id="deathScreen">
  <h2>YOU DIED</h2>
  <p>Respawning in 3 seconds...</p>
</div>

<!-- KILL CAM -->
<div id="killCam">
  <div class="kill-cam-title">KILL CAM</div>
  <div class="kill-cam-info">
    <span class="kill-cam-killer" id="kcKiller">Killer</span>
    <span> killed you with </span>
    <span class="kill-cam-weapon" id="kcWeapon">AK-47</span>
  </div>
</div>

<!-- SCOREBOARD -->
<div id="scoreboard">
  <div class="sb-header">SCOREBOARD</div>
  <table class="sb-table">
    <thead><tr><th></th><th>NAME</th><th>K</th><th>D</th><th>$</th><th>HP</th></tr></thead>
    <tbody id="sbBody"></tbody>
  </table>
</div>

<!-- CHAT -->
<div id="chatBox">
  <div class="chat-msgs" id="chatMsgs"></div>
  <input class="chat-input" id="chatInput" placeholder="Type message..." maxlength="100">
</div>

<!-- IN-GAME MENU -->
<div id="ingameMenu">
  <button class="ingame-btn" onclick="resumeGame()">RESUME</button>
  <button class="ingame-btn" onclick="showSettings()">SETTINGS</button>
  <button class="ingame-btn" onclick="leaveServer()">LEAVE SERVER</button>
</div>

<!-- ACHIEVEMENT POPUP -->
<div id="achievementPopup">
  <div class="ach-popup-icon" id="achPopupIcon">ğŸ†</div>
  <div class="ach-popup-name" id="achPopupName">Achievement!</div>
  <div class="ach-popup-desc" id="achPopupDesc">Description</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAXIS STRIKE v5.0 â€” RPG, PHYSICS, DESTRUCTION, SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// AUDIO
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new AudioCtx()}
function playSound(type){
  ensureAudio();const vol=parseInt(document.getElementById('volume').value)/100;
  const g=audioCtx.createGain();g.gain.value=0.15*vol;g.connect(audioCtx.destination);
  if(type==='shoot'){
    const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.08,audioCtx.sampleRate);
    const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3);
    const s=audioCtx.createBufferSource();s.buffer=buf;s.connect(g);s.start();
  }else if(type==='explosion'){
    const osc=audioCtx.createOscillator();osc.type='sawtooth';osc.frequency.value=80;
    osc.frequency.exponentialRampToValueAtTime(20,audioCtx.currentTime+0.5);
    const g2=audioCtx.createGain();g2.gain.value=0.3*vol;g2.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.5);
    osc.connect(g2);g2.connect(audioCtx.destination);osc.start();osc.stop(audioCtx.currentTime+0.5);
  }else if(type==='hit'){
    const osc=audioCtx.createOscillator();osc.type='sine';osc.frequency.value=800;
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);
    osc.connect(g);osc.start();osc.stop(audioCtx.currentTime+0.1);
  }
}

// GAME STATE
let ws=null,myId=null,myPlayer=null,players={},currentRoom=null,currentMap='MS_START';
let scene,camera,renderer;
let moveState={forward:0,back:0,left:0,right:0,jump:false};
let velocity=new THREE.Vector3(),yaw=0,pitch=0,onGround=true;
let inGame=false,isAlive=true,hp=100,money=800;
let chatOpen=false,shopOpen=false,shooting=false;
let selectedServerId=null,mobileControlsEnabled=false;
let currentCrosshairStyle='default',currentSkin='1';

// WEAPONS
const WEAPONS={
  knife:{name:'Knife',clip:0,maxClip:0,total:0,fireRate:500,reloadTime:0,auto:false,melee:true,model:'knife'},
  usp:{name:'USP',clip:12,maxClip:12,total:36,fireRate:200,reloadTime:1500,auto:false,melee:false,model:'pistol'},
  deagle:{name:'Desert Eagle',clip:7,maxClip:7,total:35,fireRate:300,reloadTime:1800,auto:false,melee:false,model:'deagle'},
  ak47:{name:'AK-47',clip:30,maxClip:30,total:90,fireRate:100,reloadTime:2500,auto:true,melee:false,model:'ak47'},
  m4a1:{name:'M4A1',clip:30,maxClip:30,total:90,fireRate:90,reloadTime:2300,auto:true,melee:false,model:'m4a1'},
  awp:{name:'AWP',clip:5,maxClip:5,total:20,fireRate:1500,reloadTime:3000,auto:false,melee:false,model:'awp'},
  rpg:{name:'RPG-7',clip:1,maxClip:1,total:3,fireRate:2000,reloadTime:3500,auto:false,melee:false,model:'rpg',explosive:true}
};
let currentWeapon='knife',ownedWeapons=['knife'],lastShot=0;
let weaponPrices={knife:0,usp:500,deagle:1500,ak47:2000,m4a1:2500,awp:4000,rpg:5000};

// 3D OBJECTS
let otherPlayerMeshes={},gunMesh=null,mapBoxes=[],physicsObjects=[],destructibleWalls=[],debrisMeshes=[];
let mapSize=50,buyZoneT={x:-25,z:0,radius:8},buyZoneCT={x:25,z:0,radius:8};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getWebSocketURL(){
  const protocol=window.location.protocol==='https:'?'wss:':'ws:';
  const host=window.location.host;
  if(window.location.protocol==='file:')return'ws://localhost:3000';
  return`${protocol}//${host}`;
}

function connectWebSocket(){
  return new Promise((resolve,reject)=>{
    if(ws&&ws.readyState===WebSocket.OPEN){resolve();return}
    const addr=getWebSocketURL();
    ws=new WebSocket(addr);
    ws.onopen=()=>{
      console.log('Connected');
      const name=document.getElementById('playerName').value||'Player';
      ws.send(JSON.stringify({type:'setName',name}));
      resolve();
    };
    ws.onmessage=(e)=>{handleServerMessage(JSON.parse(e.data))};
    ws.onclose=()=>{document.getElementById('connStatus').className='conn-status err';document.getElementById('connStatus').textContent='DISCONNECTED'};
    ws.onerror=()=>{reject(new Error('Connection failed'))};
  });
}

function showServerBrowser(){
  connectWebSocket().then(()=>{
    document.getElementById('serverBrowser').classList.add('show');
    ws.send(JSON.stringify({type:'getRooms'}));
  }).catch(()=>{alert('Cannot connect to server!\nRun: node server.js')});
}
function hideServerBrowser(){document.getElementById('serverBrowser').classList.remove('show')}
function refreshServers(){if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'getRooms'}))}
function selectMap(el){document.querySelectorAll('.map-option').forEach(e=>e.classList.remove('selected'));el.classList.add('selected')}
function selectMode(el){document.querySelectorAll('.mode-option').forEach(e=>e.classList.remove('selected'));el.classList.add('selected')}

function renderServerList(rooms){
  const list=document.getElementById('serverList');
  if(rooms.length===0){list.innerHTML='<div class="no-servers">No servers available. Create one!</div>';return}
  list.innerHTML=rooms.map(r=>`
    <div class="server-item" data-id="${r.id}" data-password="${r.hasPassword}" onclick="selectServer(${r.id},${r.hasPassword})">
      <span class="name">${r.name}${r.hasPassword?'<span class="lock">ğŸ”’</span>':''}</span>
      <span class="map">${r.map}</span>
      <span class="mode">${r.mode==='hostage'?'Hostage':'TDM'}</span>
      <span class="players">${r.players}/${r.maxPlayers}</span>
    </div>
  `).join('');
}

function selectServer(id,hasPassword){
  selectedServerId=id;
  document.querySelectorAll('.server-item').forEach(e=>e.classList.remove('selected'));
  document.querySelector(`.server-item[data-id="${id}"]`).classList.add('selected');
  document.getElementById('joinBtn').disabled=false;
}

function joinSelectedServer(){
  if(!selectedServerId)return;
  const item=document.querySelector(`.server-item[data-id="${selectedServerId}"]`);
  const hasPassword=item.dataset.password==='true';
  if(hasPassword){document.getElementById('passwordPrompt').classList.add('show');document.getElementById('joinPassword').focus()}
  else{ws.send(JSON.stringify({type:'joinRoom',roomId:selectedServerId,password:''}))}
}

function submitPassword(){
  const password=document.getElementById('joinPassword').value;
  ws.send(JSON.stringify({type:'joinRoom',roomId:selectedServerId,password}));
  hidePasswordPrompt();
}
function hidePasswordPrompt(){document.getElementById('passwordPrompt').classList.remove('show');document.getElementById('joinPassword').value=''}

function createServer(){
  const name=document.getElementById('createName').value||'My Server';
  const password=document.getElementById('createPassword').value;
  const map=document.querySelector('.map-option.selected').dataset.map;
  const mode=document.querySelector('.mode-option.selected').dataset.mode;
  ws.send(JSON.stringify({type:'createRoom',name,password,map,mode}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleServerMessage(data){
  switch(data.type){
    case'welcome':myId=data.id;if(data.weaponPrices)weaponPrices=data.weaponPrices;break;
    case'roomList':renderServerList(data.rooms);break;
    case'joinError':alert('Error: '+data.error);break;
    case'joinedRoom':
      currentRoom=data.roomId;currentMap=data.map;myPlayer=data.player;players=data.players;
      money=myPlayer.money;ownedWeapons=myPlayer.weapons||['knife'];
      if(data.destructibleWalls)destructibleWalls=data.destructibleWalls;
      if(data.physicsObjects)physicsObjects=data.physicsObjects;
      if(data.mapSize)mapSize=data.mapSize;
      if(data.weaponPrices)weaponPrices=data.weaponPrices;
      hideServerBrowser();startGame();break;
    case'playerJoin':players[data.player.id]=data.player;createPlayerMesh(data.player.id,data.player);addChat('SERVER',data.player.name+' joined');break;
    case'playerLeave':delete players[data.id];removePlayerMesh(data.id);addChat('SERVER','Player disconnected');break;
    case'playerMove':
      if(data.id!=myId&&otherPlayerMeshes[data.id]){
        const pm=otherPlayerMeshes[data.id];
        pm.targetPos=new THREE.Vector3(data.x,data.y-1.7,data.z);
        pm.mesh.rotation.y=-data.ry;
      }
      if(players[data.id]){players[data.id].x=data.x;players[data.id].y=data.y;players[data.id].z=data.z}
      break;
    case'playerShoot':
      if(data.id!=myId){
        playSound('shoot');
        if(data.weapon!=='knife'&&data.weapon!=='rpg')showTracer(data.x,data.y,data.z,data.dx,data.dy,data.dz);
        if(data.weapon==='rpg')showRocket(data.x,data.y,data.z,data.dx,data.dy,data.dz);
      }
      break;
    case'hit':hp=data.hp;updateHP();showDamage(data.fromX,data.fromZ);playSound('hit');break;
    case'hitConfirm':showHitMarker();playSound('hit');break;
    case'kill':
      addKillFeed(data.killerId,data.victimId,data.weapon,data.headshot);
      if(data.victimId===myId){
        isAlive=false;document.getElementById('deathScreen').classList.add('show');
        document.getElementById('kcKiller').textContent=data.killCam.killerName;
        document.getElementById('kcWeapon').textContent=data.weapon.toUpperCase();
        document.getElementById('killCam').classList.add('show');
      }
      if(data.killerId===myId&&data.killerMoney!==undefined){money=data.killerMoney;updateMoney()}
      break;
    case'respawn':
      if(data.id===myId){
        isAlive=true;hp=100;money=data.money||money;
        updateHP();updateMoney();
        camera.position.set(data.x,data.y,data.z);
        document.getElementById('deathScreen').classList.remove('show');
        document.getElementById('killCam').classList.remove('show');
        currentWeapon='knife';ownedWeapons=['knife'];
        updateWeaponUI();
      }
      break;
    case'state':
      players=data.players;
      if(data.scores){document.getElementById('scoreT').textContent=data.scores.T||0;document.getElementById('scoreCT').textContent=data.scores.CT||0}
      for(let pid in players){if(pid!=myId&&!otherPlayerMeshes[pid])createPlayerMesh(pid,players[pid])}
      for(let pid in otherPlayerMeshes){if(!players[pid])removePlayerMesh(pid)}
      break;
    case'chat':addChat(data.name,data.msg,data.team);break;
    case'weaponBought':
      money=data.money;ownedWeapons=data.weapons;currentWeapon=data.weapon;
      updateMoney();updateWeaponUI();createGunModel(currentWeapon);
      closeShop();addChat('SHOP','Bought '+WEAPONS[data.weapon].name);break;
    case'buyError':addChat('SHOP',data.error);break;
    case'explosion':createExplosion(data.x,data.y,data.z,data.radius);playSound('explosion');break;
    case'physicsUpdate':
      physicsObjects=data.objects;
      updatePhysicsObjects();
      break;
    case'objectDestroyed':
      createDebris(data.x,data.y,data.z,data.debrisCount);
      const obj=physicsObjects.find(o=>o.id===data.id);
      if(obj)obj.destroyed=true;
      updatePhysicsObjects();
      break;
    case'wallDestroyed':
      const wall=destructibleWalls.find(w=>w.id===data.wallId);
      if(wall){wall.destroyed=true;removeWallMesh(data.wallId)}
      createDebris(wall.x,wall.y,wall.z,data.debris.length);
      break;
    case'wallDamaged':
      const dwall=destructibleWalls.find(w=>w.id===data.wallId);
      if(dwall)dwall.hp=data.hp;
      break;
    case'mapResize':mapSize=data.size;rebuildMapBounds();break;
    case'gibEffect':createGibEffect(data.x,data.y,data.z);break;
    case'newAchievements':data.achievements.forEach(a=>showAchievementPopup(a));break;
    case'kicked':alert('Kicked: '+data.reason);leaveServer();break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startGame(){
  if(!scene)init3D();
  buildMap();
  createGunModel(currentWeapon);
  if(myPlayer){camera.position.set(myPlayer.x,myPlayer.y,myPlayer.z);yaw=myPlayer.ry;pitch=0}
  const team=myPlayer?myPlayer.team:'T';
  document.getElementById('teamIndicator').className='team-indicator '+team;
  document.getElementById('teamIndicator').textContent=team==='T'?'TERRORIST':'COUNTER-TERRORIST';
  document.getElementById('connStatus').className='conn-status ok';
  document.getElementById('connStatus').textContent='CONNECTED';
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('hud').classList.remove('hidden');
  if(mobileControlsEnabled)document.getElementById('mobileControls').classList.add('show');
  inGame=true;isAlive=true;hp=100;updateHP();updateMoney();updateWeaponUI();
  renderer.domElement.requestPointerLock();
  requestAnimationFrame(gameLoop);
}

function leaveServer(){
  if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'leaveRoom'}));
  inGame=false;currentRoom=null;players={};
  document.getElementById('ingameMenu').classList.remove('show');
  document.getElementById('hud').classList.add('hidden');
  document.getElementById('mobileControls').classList.remove('show');
  document.getElementById('menu').classList.remove('hidden');
  if(document.pointerLockElement)document.exitPointerLock();
}

function resumeGame(){document.getElementById('ingameMenu').classList.remove('show');renderer.domElement.requestPointerLock()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3D INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init3D(){
  scene=new THREE.Scene();
  const fov=parseInt(document.getElementById('fovSetting').value)||75;
  camera=new THREE.PerspectiveCamera(fov,window.innerWidth/window.innerHeight,0.1,500);
  camera.position.set(0,1.7,0);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.shadowMap.enabled=true;
  document.body.prepend(renderer.domElement);
  window.addEventListener('resize',()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

function buildMap(){
  while(scene.children.length>0)scene.remove(scene.children[0]);
  mapBoxes=[];
  for(let id in otherPlayerMeshes)removePlayerMesh(id);
  
  // Lights
  const amb=new THREE.AmbientLight(currentMap==='MS_DUST'?0xffeedd:currentMap==='MS_ARENA_BETA'?0xccccff:0xaabbcc,0.5);
  scene.add(amb);
  const sun=new THREE.DirectionalLight(0xffffff,1.2);
  sun.position.set(40,60,30);sun.castShadow=true;
  scene.add(sun);
  
  // Ground
  const groundColor=currentMap==='MS_DUST'?0xC4A35A:currentMap==='MS_ARENA_BETA'?0x404050:0x708090;
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshLambertMaterial({color:groundColor}));
  ground.rotation.x=-Math.PI/2;ground.receiveShadow=true;
  scene.add(ground);
  
  // Sky
  const skyColor=currentMap==='MS_DUST'?0x87CEEB:currentMap==='MS_ARENA_BETA'?0x1a1a2e:0x4a5a6a;
  scene.background=new THREE.Color(skyColor);
  scene.fog=new THREE.Fog(skyColor,60,150);
  
  // Build map structures
  if(currentMap==='MS_ARENA_BETA'){
    buildArenaBeta();
  }else if(currentMap==='MS_DUST'){
    buildDust();
  }else{
    buildStart();
  }
  
  // Create player meshes
  for(let pid in players){if(pid!=myId)createPlayerMesh(pid,players[pid])}
}

function addWall(x,y,z,w,h,d,color){
  const geo=new THREE.BoxGeometry(w,h,d);
  const mat=new THREE.MeshLambertMaterial({color:color||0x888888});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(x,y,z);mesh.castShadow=true;mesh.receiveShadow=true;
  scene.add(mesh);
  mapBoxes.push({mesh,min:{x:x-w/2,y:y-h/2,z:z-d/2},max:{x:x+w/2,y:y+h/2,z:z+d/2}});
  return mesh;
}

function addBarrel(x,z){
  const geo=new THREE.CylinderGeometry(0.5,0.5,1.2,12);
  const mat=new THREE.MeshLambertMaterial({color:0x8B0000});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(x,0.6,z);mesh.castShadow=true;
  scene.add(mesh);
  return mesh;
}

function addCrate(x,z,s){
  s=s||1.5;
  const geo=new THREE.BoxGeometry(s,s,s);
  const mat=new THREE.MeshLambertMaterial({color:0x8B6914});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(x,s/2,z);mesh.castShadow=true;
  scene.add(mesh);
  mapBoxes.push({mesh,min:{x:x-s/2,y:0,z:z-s/2},max:{x:x+s/2,y:s,z:z+s/2}});
}

function buildStart(){
  buyZoneT={x:-25,z:0,radius:8};buyZoneCT={x:25,z:0,radius:8};
  // Perimeter
  addWall(0,3,-50,100,6,2,0x606060);
  addWall(0,3,50,100,6,2,0x606060);
  addWall(-50,3,0,2,6,100,0x606060);
  addWall(50,3,0,2,6,100,0x606060);
  // Center
  addWall(0,2.5,0,8,5,8,0x707070);
  // Crates
  addCrate(-8,8);addCrate(8,-8);addCrate(-8,-8);addCrate(8,8);
  // Buy zones visualization
  createBuyZone(-25,0,8,0xff6600);
  createBuyZone(25,0,8,0x0066ff);
}

function buildDust(){
  buyZoneT={x:-45,z:-45,radius:10};buyZoneCT={x:45,z:45,radius:10};
  // Perimeter
  addWall(0,3,-75,150,6,2,0xa08060);
  addWall(0,3,75,150,6,2,0xa08060);
  addWall(-75,3,0,2,6,150,0xa08060);
  addWall(75,3,0,2,6,150,0xa08060);
  // Buildings
  addWall(-45,2,-45,20,4,1,0xa08060);
  addWall(-45,2,-35,1,4,20,0xa08060);
  addWall(45,2,45,20,4,1,0xa08060);
  addWall(45,2,35,1,4,20,0xa08060);
  addWall(0,3,-10,20,6,2,0xa08060);
  addWall(0,3,10,20,6,2,0xa08060);
  // Crates
  addCrate(-35,-30);addCrate(-25,-35);addCrate(35,30);addCrate(25,35);
  // Buy zones
  createBuyZone(-45,-45,10,0xff6600);
  createBuyZone(45,45,10,0x0066ff);
}

function buildArenaBeta(){
  buyZoneT={x:-15,z:0,radius:6};buyZoneCT={x:15,z:0,radius:6};
  
  // Dynamic perimeter based on mapSize
  const s=mapSize;
  addWall(0,3,-s,s*2,6,2,0x4a4a5a);
  addWall(0,3,s,s*2,6,2,0x4a4a5a);
  addWall(-s,3,0,2,6,s*2,0x4a4a5a);
  addWall(s,3,0,2,6,s*2,0x4a4a5a);
  
  // Add destructible walls
  for(const wall of destructibleWalls){
    if(!wall.destroyed){
      const mesh=addWall(wall.x,wall.y,wall.z,wall.width,wall.height,wall.depth,0x8B4513);
      mesh.userData.wallId=wall.id;
      mesh.userData.destructible=true;
    }
  }
  
  // Add physics objects (barrels, crates)
  for(const obj of physicsObjects){
    if(!obj.destroyed){
      let mesh;
      if(obj.type==='barrel'){
        mesh=addBarrel(obj.x,obj.z);
      }else{
        addCrate(obj.x,obj.z,obj.size);
      }
      if(mesh)mesh.userData.physicsId=obj.id;
    }
  }
  
  // Buy zones
  createBuyZone(-15,0,6,0xff6600);
  createBuyZone(15,0,6,0x0066ff);
}

function createBuyZone(x,z,radius,color){
  const geo=new THREE.RingGeometry(radius-0.5,radius,32);
  const mat=new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.3,side:THREE.DoubleSide});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.rotation.x=-Math.PI/2;mesh.position.set(x,0.1,z);
  scene.add(mesh);
}

function rebuildMapBounds(){
  // Remove old perimeter and rebuild for MS_ARENA_BETA
  if(currentMap==='MS_ARENA_BETA'){
    buildMap();
  }
}

function updatePhysicsObjects(){
  // Update positions of physics objects
  for(const obj of physicsObjects){
    if(obj.destroyed)continue;
    const mesh=scene.children.find(c=>c.userData&&c.userData.physicsId===obj.id);
    if(mesh){
      mesh.position.set(obj.x,obj.y,obj.z);
    }
  }
}

function removeWallMesh(wallId){
  const mesh=scene.children.find(c=>c.userData&&c.userData.wallId===wallId);
  if(mesh){
    scene.remove(mesh);
    const idx=mapBoxes.findIndex(b=>b.mesh===mesh);
    if(idx!==-1)mapBoxes.splice(idx,1);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER MESHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function createPlayerMesh(id,pdata){
  if(id==myId||otherPlayerMeshes[id])return;
  const group=new THREE.Group();
  const isT=pdata.team==='T';
  const bodyColor=isT?0xc4782a:0x2a5a8a;
  
  const body=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.9,0.4),new THREE.MeshLambertMaterial({color:bodyColor}));
  body.position.y=0.95;body.castShadow=true;group.add(body);
  
  const head=new THREE.Mesh(new THREE.BoxGeometry(0.35,0.35,0.35),new THREE.MeshLambertMaterial({color:0xdaa06d}));
  head.position.y=1.6;head.castShadow=true;group.add(head);
  
  for(let side of[-1,1]){
    const leg=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.5,0.25),new THREE.MeshLambertMaterial({color:0x333333}));
    leg.position.set(side*0.15,0.25,0);group.add(leg);
    const arm=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.6,0.15),new THREE.MeshLambertMaterial({color:bodyColor}));
    arm.position.set(side*0.38,1.0,-0.1);group.add(arm);
  }
  
  group.position.set(pdata.x||0,0,pdata.z||0);
  scene.add(group);
  otherPlayerMeshes[id]={mesh:group,targetPos:new THREE.Vector3(pdata.x||0,0,pdata.z||0)};
}

function removePlayerMesh(id){if(otherPlayerMeshes[id]){scene.remove(otherPlayerMeshes[id].mesh);delete otherPlayerMeshes[id]}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUN MODELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function createGunModel(weaponType){
  if(gunMesh)camera.remove(gunMesh);
  gunMesh=new THREE.Group();
  
  const skinColors={
    '1':{wood:0x8B4513,metal:0x654321},
    '2':{wood:0x2F4F4F,metal:0x1a3a3a},
    '3':{wood:0x8B0000,metal:0x4a0000}
  };
  const skin=skinColors[currentSkin]||skinColors['1'];
  
  if(weaponType==='knife'){
    const blade=new THREE.Mesh(new THREE.BoxGeometry(0.01,0.025,0.22),new THREE.MeshLambertMaterial({color:0xCCCCCC}));
    blade.position.set(0,0,-0.15);gunMesh.add(blade);
    const handle=new THREE.Mesh(new THREE.BoxGeometry(0.025,0.03,0.12),new THREE.MeshLambertMaterial({color:skin.wood}));
    handle.position.set(0,0,0.04);gunMesh.add(handle);
    gunMesh.position.set(0.2,-0.1,-0.25);gunMesh.rotation.x=0.3;
  }else if(weaponType==='ak47'||weaponType==='m4a1'){
    const receiver=new THREE.Mesh(new THREE.BoxGeometry(0.05,0.07,0.4),new THREE.MeshLambertMaterial({color:skin.metal}));
    gunMesh.add(receiver);
    const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.015,0.015,0.35,8),new THREE.MeshLambertMaterial({color:0x333333}));
    barrel.rotation.x=Math.PI/2;barrel.position.set(0,0.015,-0.35);gunMesh.add(barrel);
    const mag=new THREE.Mesh(new THREE.BoxGeometry(0.035,0.18,0.06),new THREE.MeshLambertMaterial({color:skin.wood}));
    mag.position.set(0,-0.12,0);mag.rotation.x=0.2;gunMesh.add(mag);
    const stock=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.05,0.25),new THREE.MeshLambertMaterial({color:skin.wood}));
    stock.position.set(0,-0.01,0.28);gunMesh.add(stock);
    gunMesh.position.set(0.22,-0.18,-0.35);
  }else if(weaponType==='deagle'||weaponType==='usp'){
    const slide=new THREE.Mesh(new THREE.BoxGeometry(0.035,0.05,0.25),new THREE.MeshLambertMaterial({color:skin.metal}));
    gunMesh.add(slide);
    const grip=new THREE.Mesh(new THREE.BoxGeometry(0.03,0.1,0.04),new THREE.MeshLambertMaterial({color:skin.wood}));
    grip.position.set(0,-0.08,0.08);grip.rotation.x=-0.15;gunMesh.add(grip);
    gunMesh.position.set(0.18,-0.15,-0.28);
  }else if(weaponType==='awp'){
    const body=new THREE.Mesh(new THREE.BoxGeometry(0.06,0.08,0.6),new THREE.MeshLambertMaterial({color:0x2a4a2a}));
    gunMesh.add(body);
    const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.5,8),new THREE.MeshLambertMaterial({color:0x333333}));
    barrel.rotation.x=Math.PI/2;barrel.position.set(0,0.02,-0.5);gunMesh.add(barrel);
    const scope=new THREE.Mesh(new THREE.CylinderGeometry(0.025,0.025,0.15,8),new THREE.MeshLambertMaterial({color:0x111111}));
    scope.position.set(0,0.08,0);gunMesh.add(scope);
    const stock=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.06,0.25),new THREE.MeshLambertMaterial({color:skin.wood}));
    stock.position.set(0,-0.01,0.35);gunMesh.add(stock);
    gunMesh.position.set(0.2,-0.15,-0.4);
  }else if(weaponType==='rpg'){
    const tube=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.8,12),new THREE.MeshLambertMaterial({color:0x4a6a4a}));
    tube.rotation.x=Math.PI/2;gunMesh.add(tube);
    const grip=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.12,0.04),new THREE.MeshLambertMaterial({color:skin.wood}));
    grip.position.set(0,-0.1,0.1);gunMesh.add(grip);
    const sight=new THREE.Mesh(new THREE.BoxGeometry(0.02,0.06,0.02),new THREE.MeshLambertMaterial({color:0x333333}));
    sight.position.set(0,0.08,-0.2);gunMesh.add(sight);
    gunMesh.position.set(0.25,-0.1,-0.35);
  }
  
  camera.add(gunMesh);
  if(!camera.parent)scene.add(camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EFFECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showTracer(x,y,z,dx,dy,dz){
  const geo=new THREE.BufferGeometry().setFromPoints([
    new THREE.Vector3(x,y,z),
    new THREE.Vector3(x+dx*60,y+dy*60,z+dz*60)
  ]);
  const mat=new THREE.LineBasicMaterial({color:0xffff66,transparent:true,opacity:0.5});
  const line=new THREE.Line(geo,mat);
  scene.add(line);
  setTimeout(()=>scene.remove(line),80);
}

function showRocket(x,y,z,dx,dy,dz){
  const rocketGeo=new THREE.ConeGeometry(0.1,0.4,8);
  const rocketMat=new THREE.MeshBasicMaterial({color:0x888888});
  const rocket=new THREE.Mesh(rocketGeo,rocketMat);
  rocket.position.set(x,y,z);
  rocket.lookAt(x+dx,y+dy,z+dz);
  rocket.rotateX(Math.PI/2);
  scene.add(rocket);
  
  const speed=50;
  const startTime=Date.now();
  
  function animateRocket(){
    const elapsed=(Date.now()-startTime)/1000;
    rocket.position.x=x+dx*speed*elapsed;
    rocket.position.y=y+dy*speed*elapsed;
    rocket.position.z=z+dz*speed*elapsed;
    
    if(elapsed>2){
      scene.remove(rocket);
      return;
    }
    
    // Check collision with walls
    for(const box of mapBoxes){
      if(rocket.position.x>box.min.x&&rocket.position.x<box.max.x&&
         rocket.position.y>box.min.y&&rocket.position.y<box.max.y&&
         rocket.position.z>box.min.z&&rocket.position.z<box.max.z){
        scene.remove(rocket);
        if(ws&&ws.readyState===WebSocket.OPEN){
          ws.send(JSON.stringify({type:'rpgExplode',x:rocket.position.x,y:rocket.position.y,z:rocket.position.z}));
          // Check if hit destructible wall
          if(box.mesh.userData.destructible){
            ws.send(JSON.stringify({type:'destroyWall',wallId:box.mesh.userData.wallId,damage:100}));
          }
        }
        createExplosion(rocket.position.x,rocket.position.y,rocket.position.z,8);
        playSound('explosion');
        return;
      }
    }
    
    requestAnimationFrame(animateRocket);
  }
  animateRocket();
}

function createExplosion(x,y,z,radius){
  // Visual explosion
  const explosionGeo=new THREE.SphereGeometry(radius,16,16);
  const explosionMat=new THREE.MeshBasicMaterial({color:0xff6600,transparent:true,opacity:0.8});
  const explosion=new THREE.Mesh(explosionGeo,explosionMat);
  explosion.position.set(x,y,z);
  scene.add(explosion);
  
  let scale=0.1;
  function animateExplosion(){
    scale+=0.2;
    explosion.scale.set(scale,scale,scale);
    explosionMat.opacity-=0.05;
    if(explosionMat.opacity>0){
      requestAnimationFrame(animateExplosion);
    }else{
      scene.remove(explosion);
    }
  }
  animateExplosion();
  
  // Particles
  for(let i=0;i<20;i++){
    const pGeo=new THREE.SphereGeometry(0.1+Math.random()*0.2,6,6);
    const pMat=new THREE.MeshBasicMaterial({color:Math.random()>0.5?0xff6600:0xff0000});
    const p=new THREE.Mesh(pGeo,pMat);
    p.position.set(x,y,z);
    const vx=(Math.random()-0.5)*20;
    const vy=Math.random()*15;
    const vz=(Math.random()-0.5)*20;
    scene.add(p);
    
    let t=0;
    function animateParticle(){
      t+=0.016;
      p.position.x+=vx*0.016;
      p.position.y+=vy*0.016-9.8*t*0.016;
      p.position.z+=vz*0.016;
      if(t<2&&p.position.y>0){
        requestAnimationFrame(animateParticle);
      }else{
        scene.remove(p);
      }
    }
    animateParticle();
  }
}

function createDebris(x,y,z,count){
  for(let i=0;i<count;i++){
    const size=0.2+Math.random()*0.4;
    const geo=new THREE.BoxGeometry(size,size,size);
    const mat=new THREE.MeshLambertMaterial({color:0x8B4513});
    const debris=new THREE.Mesh(geo,mat);
    debris.position.set(x+(Math.random()-0.5)*2,y+(Math.random()-0.5)*2,z+(Math.random()-0.5)*2);
    debris.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
    scene.add(debris);
    
    const vx=(Math.random()-0.5)*10;
    const vy=Math.random()*8;
    const vz=(Math.random()-0.5)*10;
    let t=0;
    
    function animateDebris(){
      t+=0.016;
      debris.position.x+=vx*0.016;
      debris.position.y+=vy*0.016-9.8*t*0.016;
      debris.position.z+=vz*0.016;
      debris.rotation.x+=0.1;debris.rotation.y+=0.1;
      if(debris.position.y<size/2){debris.position.y=size/2;return}
      if(t<30){requestAnimationFrame(animateDebris)}else{scene.remove(debris)}
    }
    animateDebris();
    
    // Remove after 30 seconds
    setTimeout(()=>scene.remove(debris),30000);
  }
}

function createGibEffect(x,y,z){
  // Gore particles (limbs)
  const limbColors=[0xdaa06d,0x8B0000,0x660000];
  for(let i=0;i<8;i++){
    const size=0.15+Math.random()*0.2;
    const geo=new THREE.BoxGeometry(size,size*2,size);
    const mat=new THREE.MeshLambertMaterial({color:limbColors[Math.floor(Math.random()*limbColors.length)]});
    const limb=new THREE.Mesh(geo,mat);
    limb.position.set(x,y,z);
    scene.add(limb);
    
    const vx=(Math.random()-0.5)*15;
    const vy=Math.random()*12;
    const vz=(Math.random()-0.5)*15;
    let t=0;
    
    function animateLimb(){
      t+=0.016;
      limb.position.x+=vx*0.016;
      limb.position.y+=vy*0.016-9.8*t*0.016;
      limb.position.z+=vz*0.016;
      limb.rotation.x+=0.15;limb.rotation.z+=0.1;
      if(limb.position.y<0.1){limb.position.y=0.1;return}
      if(t<5){requestAnimationFrame(animateLimb)}
    }
    animateLimb();
    setTimeout(()=>scene.remove(limb),5000);
  }
  
  // Blood splatter
  for(let i=0;i<30;i++){
    const pGeo=new THREE.SphereGeometry(0.05+Math.random()*0.1,4,4);
    const pMat=new THREE.MeshBasicMaterial({color:0x8B0000});
    const blood=new THREE.Mesh(pGeo,pMat);
    blood.position.set(x,y,z);
    scene.add(blood);
    
    const vx=(Math.random()-0.5)*10;
    const vy=Math.random()*8;
    const vz=(Math.random()-0.5)*10;
    let t=0;
    
    function animateBlood(){
      t+=0.016;
      blood.position.x+=vx*0.016;
      blood.position.y+=vy*0.016-15*t*0.016;
      blood.position.z+=vz*0.016;
      if(blood.position.y<0.05||t>3){scene.remove(blood);return}
      requestAnimationFrame(animateBlood);
    }
    animateBlood();
  }
}

function showHitMarker(){
  const el=document.getElementById('hitMarker');
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),200);
}

function showDamage(fromX,fromZ){
  document.getElementById('dmgOverlay').classList.add('hit');
  setTimeout(()=>document.getElementById('dmgOverlay').classList.remove('hit'),150);
  document.getElementById('bloodEffect').classList.add('show');
  setTimeout(()=>document.getElementById('bloodEffect').classList.remove('show'),500);
  
  // Damage direction
  if(fromX!==undefined&&fromZ!==undefined){
    const angle=Math.atan2(fromX-camera.position.x,fromZ-camera.position.z)-yaw;
    const indicator=document.getElementById('damageIndicator');
    indicator.innerHTML=`<div class="damage-arrow" style="top:50%;left:50%;transform:translate(-50%,-50%) rotate(${angle}rad) translateY(-80px)"></div>`;
    indicator.classList.add('show');
    setTimeout(()=>indicator.classList.remove('show'),1000);
  }
}

function showMuzzleFlash(){
  const el=document.getElementById('muzzleFlash');
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),50);
}

function showAchievementPopup(ach){
  const popup=document.getElementById('achievementPopup');
  document.getElementById('achPopupIcon').textContent=ach.icon;
  document.getElementById('achPopupName').textContent=ach.name;
  document.getElementById('achPopupDesc').textContent=ach.desc;
  popup.classList.add('show');
  setTimeout(()=>popup.classList.remove('show'),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openShop(){
  if(!isAlive)return;
  // Check buy zone
  const team=myPlayer?myPlayer.team:'T';
  const buyZone=team==='T'?buyZoneT:buyZoneCT;
  const dx=camera.position.x-buyZone.x;
  const dz=camera.position.z-buyZone.z;
  const dist=Math.sqrt(dx*dx+dz*dz);
  if(dist>buyZone.radius){addChat('SHOP','Not in buy zone!');return}
  
  shopOpen=true;
  document.getElementById('shopMoney').textContent=money;
  const grid=document.getElementById('shopGrid');
  grid.innerHTML='';
  
  const weaponIcons={knife:'ğŸ”ª',usp:'ğŸ”«',deagle:'ğŸ”«',ak47:'ğŸ”«',m4a1:'ğŸ”«',awp:'ğŸ¯',rpg:'ğŸš€'};
  
  for(const[wid,price]of Object.entries(weaponPrices)){
    const owned=ownedWeapons.includes(wid);
    const canAfford=money>=price;
    const div=document.createElement('div');
    div.className='shop-item'+(owned?' owned':'')+((!canAfford&&!owned)?' cant-afford':'');
    div.innerHTML=`
      <div class="weapon-icon">${weaponIcons[wid]||'ğŸ”«'}</div>
      <div class="weapon-name">${WEAPONS[wid].name}</div>
      <div class="weapon-price">${owned?'OWNED':'$'+price}</div>
    `;
    if(!owned&&canAfford){
      div.onclick=()=>buyWeapon(wid);
    }
    grid.appendChild(div);
  }
  
  document.getElementById('shopPanel').classList.add('show');
  if(document.pointerLockElement)document.exitPointerLock();
}

function closeShop(){
  shopOpen=false;
  document.getElementById('shopPanel').classList.remove('show');
  renderer.domElement.requestPointerLock();
}

function buyWeapon(weapon){
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'buyWeapon',weapon}));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOOTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function tryShoot(){
  const w=WEAPONS[currentWeapon];
  if(!w||!isAlive)return;
  if(w.reloading)return;
  if(Date.now()-lastShot<w.fireRate)return;
  if(!w.melee&&w.clip<=0){reload();return}
  
  lastShot=Date.now();
  
  if(!w.melee){w.clip--;updateWeaponUI();showMuzzleFlash()}
  playSound('shoot');
  
  // Recoil
  if(currentWeapon!=='knife'){
    pitch+=Math.random()*0.015+0.005;
    yaw+=(Math.random()-0.5)*0.008;
  }
  camera.rotation.order='YXZ';
  camera.rotation.y=-yaw;
  camera.rotation.x=-pitch;
  
  const shootDir=new THREE.Vector3();
  camera.getWorldDirection(shootDir);
  
  if(!w.melee&&!w.explosive){
    const spread=currentWeapon==='awp'?0.005:currentWeapon==='ak47'?0.02:0.015;
    shootDir.x+=(Math.random()-0.5)*spread;
    shootDir.y+=(Math.random()-0.5)*spread;
    shootDir.z+=(Math.random()-0.5)*spread;
    shootDir.normalize();
    showTracer(camera.position.x,camera.position.y,camera.position.z,shootDir.x,shootDir.y,shootDir.z);
  }
  
  if(w.explosive){
    showRocket(camera.position.x,camera.position.y,camera.position.z,shootDir.x,shootDir.y,shootDir.z);
  }
  
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({
      type:'shoot',
      x:camera.position.x,y:camera.position.y,z:camera.position.z,
      dx:shootDir.x,dy:shootDir.y,dz:shootDir.z,
      weapon:currentWeapon
    }));
  }
  
  if(!w.melee&&w.clip<=0)setTimeout(()=>reload(),300);
}

function reload(){
  const w=WEAPONS[currentWeapon];
  if(!w||w.reloading||w.melee||w.total<=0||w.clip===w.maxClip)return;
  w.reloading=true;
  document.getElementById('ammoClip').textContent='...';
  setTimeout(()=>{
    const needed=w.maxClip-w.clip;
    const available=Math.min(needed,w.total);
    w.clip+=available;w.total-=available;
    w.reloading=false;
    updateWeaponUI();
  },w.reloadTime);
}

function switchWeapon(slot){
  const weaponList=ownedWeapons;
  if(slot>=weaponList.length)return;
  const newWeapon=weaponList[slot];
  if(newWeapon===currentWeapon)return;
  currentWeapon=newWeapon;
  createGunModel(currentWeapon);
  updateWeaponUI();
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'switchWeapon',weapon:currentWeapon}));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateHP(){
  const el=document.getElementById('hpNum');
  el.textContent=Math.max(0,hp);
  el.className='hp-num '+(hp>50?'ok':hp>25?'mid':'low');
}

function updateMoney(){
  document.getElementById('moneyDisplay').textContent='$'+money;
}

function updateWeaponUI(){
  const w=WEAPONS[currentWeapon];
  const ammoBar=document.getElementById('ammoBar');
  if(w.melee){
    ammoBar.classList.add('hidden');
  }else{
    ammoBar.classList.remove('hidden');
    document.getElementById('ammoClip').textContent=w.clip;
    document.getElementById('ammoTotal').textContent=w.total;
  }
  document.getElementById('weaponName').textContent=w.name.toUpperCase();
}

function addKillFeed(killerId,victimId,weapon,headshot){
  const feed=document.getElementById('killFeed');
  const entry=document.createElement('div');
  entry.className='kill-entry';
  const kName=players[killerId]?players[killerId].name:'Player';
  const vName=players[victimId]?players[victimId].name:'Player';
  const icon=weapon==='knife'?'ğŸ”ª':weapon==='rpg'?'ğŸš€':'ğŸ’¥';
  entry.innerHTML=`<span class="killer">${kName}</span>${icon}${headshot?'â˜…':''}<span class="victim">${vName}</span>`;
  feed.appendChild(entry);
  setTimeout(()=>entry.remove(),4000);
  if(feed.children.length>5)feed.firstChild.remove();
}

function addChat(name,msg,team){
  const msgs=document.getElementById('chatMsgs');
  const el=document.createElement('div');
  el.className='chat-msg';
  const teamClass=team?(team==='T'?'team-t':'team-ct'):'';
  el.innerHTML=`<span class="cn ${teamClass}">${name}:</span> ${msg}`;
  msgs.appendChild(el);
  setTimeout(()=>el.remove(),10000);
  if(msgs.children.length>8)msgs.firstChild.remove();
}

function updateRadar(){
  const canvas=document.getElementById('radarCanvas');
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,140,140);
  const scale=1.0,cx=70,cy=70;
  for(let pid in players){
    if(pid==myId||!players[pid].alive)continue;
    const p=players[pid];
    const rx=p.x-camera.position.x;
    const rz=p.z-camera.position.z;
    const cos=Math.cos(yaw),sin=Math.sin(yaw);
    const sx=(rx*cos-rz*sin)*scale+cx;
    const sy=(rx*sin+rz*cos)*scale+cy;
    if(sx>5&&sx<135&&sy>5&&sy<135){
      ctx.fillStyle=p.team==='T'?'#ff8800':'#4488ff';
      ctx.beginPath();ctx.arc(sx,sy,3,0,Math.PI*2);ctx.fill();
    }
  }
  ctx.strokeStyle='#0f0';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx,cy-10);ctx.stroke();
}

function updateScoreboard(){
  const body=document.getElementById('sbBody');
  body.innerHTML='';
  const sorted=Object.values(players).sort((a,b)=>(b.kills||0)-(a.kills||0));
  for(const p of sorted){
    const tr=document.createElement('tr');
    if(p.id==myId)tr.className='me';
    tr.innerHTML=`
      <td class="${p.team==='T'?'team-t':'team-ct'}">${p.team}</td>
      <td>${p.name||'Player'}</td>
      <td>${p.kills||0}</td>
      <td>${p.deaths||0}</td>
      <td>$${p.money||0}</td>
      <td>${p.alive?p.hp:'â˜ '}</td>
    `;
    body.appendChild(tr);
  }
}

function checkBuyZone(){
  if(!myPlayer)return;
  const team=myPlayer.team;
  const buyZone=team==='T'?buyZoneT:buyZoneCT;
  const dx=camera.position.x-buyZone.x;
  const dz=camera.position.z-buyZone.z;
  const dist=Math.sqrt(dx*dx+dz*dz);
  const indicator=document.getElementById('buyZoneIndicator');
  if(dist<=buyZone.radius){
    indicator.classList.add('show');
  }else{
    indicator.classList.remove('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let lastTime=0;
function gameLoop(time){
  if(!inGame)return;
  requestAnimationFrame(gameLoop);
  const dt=Math.min((time-lastTime)/1000,0.1);
  lastTime=time;
  
  if(!isAlive){renderer.render(scene,camera);return}
  
  // Movement
  const speed=12;
  const dir=new THREE.Vector3();
  const front=new THREE.Vector3();
  camera.getWorldDirection(front);
  front.y=0;front.normalize();
  const right=new THREE.Vector3().crossVectors(front,new THREE.Vector3(0,1,0)).normalize();
  
  if(moveState.forward)dir.add(front);
  if(moveState.back)dir.sub(front);
  if(moveState.right)dir.add(right);
  if(moveState.left)dir.sub(right);
  if(dir.length()>0)dir.normalize();
  
  velocity.x=dir.x*speed;
  velocity.z=dir.z*speed;
  if(!onGround)velocity.y-=25*dt;
  if(moveState.jump&&onGround){velocity.y=8;onGround=false}
  
  let newX=camera.position.x+velocity.x*dt;
  let newY=camera.position.y+velocity.y*dt;
  let newZ=camera.position.z+velocity.z*dt;
  
  // Collision
  const pR=0.4,pH=1.7;
  for(const box of mapBoxes){
    if(newX+pR>box.min.x&&newX-pR<box.max.x&&
       camera.position.z+pR>box.min.z&&camera.position.z-pR<box.max.z&&
       newY>box.min.y&&newY-pH<box.max.y){
      if(camera.position.x<=box.min.x-pR)newX=box.min.x-pR;
      else if(camera.position.x>=box.max.x+pR)newX=box.max.x+pR;
    }
    if(newX+pR>box.min.x&&newX-pR<box.max.x&&
       newZ+pR>box.min.z&&newZ-pR<box.max.z&&
       newY>box.min.y&&newY-pH<box.max.y){
      if(camera.position.z<=box.min.z-pR)newZ=box.min.z-pR;
      else if(camera.position.z>=box.max.z+pR)newZ=box.max.z+pR;
    }
  }
  
  let groundY=1.7;
  for(const box of mapBoxes){
    if(newX+pR>box.min.x&&newX-pR<box.max.x&&newZ+pR>box.min.z&&newZ-pR<box.max.z){
      if(box.max.y<newY&&box.max.y+pH>newY){
        groundY=Math.max(groundY,box.max.y+pH);
      }
    }
  }
  
  if(newY<=groundY){newY=groundY;velocity.y=0;onGround=true}else{onGround=false}
  
  // Bounds
  const bound=currentMap==='MS_ARENA_BETA'?mapSize-2:currentMap==='MS_DUST'?73:48;
  newX=Math.max(-bound,Math.min(bound,newX));
  newZ=Math.max(-bound,Math.min(bound,newZ));
  
  camera.position.set(newX,newY,newZ);
  
  // Auto-fire
  if(shooting&&WEAPONS[currentWeapon].auto)tryShoot();
  
  // Interpolate players
  for(let pid in otherPlayerMeshes){
    const pm=otherPlayerMeshes[pid];
    if(pm.targetPos)pm.mesh.position.lerp(pm.targetPos,0.15);
    pm.mesh.visible=players[pid]&&players[pid].alive;
  }
  
  // Send position
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({
      type:'move',
      x:camera.position.x,y:camera.position.y,z:camera.position.z,
      rx:pitch,ry:yaw
    }));
  }
  
  checkBuyZone();
  updateRadar();
  renderer.render(scene,camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showSettings(){document.getElementById('settingsPanel').classList.add('show')}
function hideSettings(){document.getElementById('settingsPanel').classList.remove('show')}
function selectCrosshair(el){
  document.querySelectorAll('.crosshair-preview').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  currentCrosshairStyle=el.dataset.style;
  document.getElementById('crosshair').className='crosshair style-'+currentCrosshairStyle;
}
function selectSkin(el){
  document.querySelectorAll('.skin-option').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  currentSkin=el.dataset.skin;
  if(inGame&&gunMesh)createGunModel(currentWeapon);
}
function toggleMobileControls(){
  mobileControlsEnabled=!mobileControlsEnabled;
  if(inGame){
    if(mobileControlsEnabled)document.getElementById('mobileControls').classList.add('show');
    else document.getElementById('mobileControls').classList.remove('show');
  }
}
function showControls(){alert('WASD-Move | Mouse-Look | LMB-Shoot | R-Reload | Space-Jump | 1-6-Weapons | B-Shop | Tab-Score | T-Chat | Esc-Menu')}
function showAbout(){alert('MAXIS STRIKE v5.0\n\nFeatures:\nâ€¢ RPG with explosions\nâ€¢ Destructible walls (MS_ARENA_BETA)\nâ€¢ Physics objects\nâ€¢ Money & Shop system\nâ€¢ 7 weapons\nâ€¢ Gib effects\nâ€¢ 3 maps')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('mousemove',(e)=>{
  if(document.pointerLockElement&&isAlive&&!chatOpen&&!shopOpen&&inGame){
    const sens=parseFloat(document.getElementById('sensitivity').value)*0.001||0.003;
    yaw+=e.movementX*sens;
    pitch+=e.movementY*sens;
    pitch=Math.max(-Math.PI/2+0.01,Math.min(Math.PI/2-0.01,pitch));
    camera.rotation.order='YXZ';
    camera.rotation.y=-yaw;
    camera.rotation.x=-pitch;
  }
});

document.addEventListener('mousedown',(e)=>{
  if(!document.pointerLockElement&&inGame&&!shopOpen){renderer.domElement.requestPointerLock();return}
  if(e.button===0&&isAlive&&!chatOpen&&!shopOpen&&inGame){shooting=true;tryShoot()}
});

document.addEventListener('mouseup',(e)=>{if(e.button===0)shooting=false});

document.addEventListener('keydown',(e)=>{
  if(chatOpen){
    if(e.key==='Enter'){
      const input=document.getElementById('chatInput');
      if(input.value.trim()&&ws&&ws.readyState===WebSocket.OPEN){
        ws.send(JSON.stringify({type:'chat',msg:input.value}));
      }
      input.value='';input.classList.remove('show');chatOpen=false;
      renderer.domElement.requestPointerLock();
    }
    if(e.key==='Escape'){
      document.getElementById('chatInput').classList.remove('show');chatOpen=false;
      renderer.domElement.requestPointerLock();
    }
    return;
  }
  
  if(shopOpen){
    if(e.code==='KeyB'||e.key==='Escape')closeShop();
    return;
  }
  
  if(!inGame)return;
  
  switch(e.code){
    case'KeyW':moveState.forward=1;break;
    case'KeyS':moveState.back=1;break;
    case'KeyA':moveState.left=1;break;
    case'KeyD':moveState.right=1;break;
    case'Space':e.preventDefault();moveState.jump=true;break;
    case'KeyR':reload();break;
    case'Digit1':switchWeapon(0);break;
    case'Digit2':switchWeapon(1);break;
    case'Digit3':switchWeapon(2);break;
    case'Digit4':switchWeapon(3);break;
    case'Digit5':switchWeapon(4);break;
    case'Digit6':switchWeapon(5);break;
    case'KeyB':openShop();break;
    case'Tab':e.preventDefault();updateScoreboard();document.getElementById('scoreboard').classList.add('show');break;
    case'KeyT':case'KeyY':
      if(document.pointerLockElement){
        document.exitPointerLock();chatOpen=true;
        const input=document.getElementById('chatInput');
        input.classList.add('show');input.focus();
      }
      break;
    case'Escape':
      if(document.pointerLockElement){
        document.exitPointerLock();
        document.getElementById('ingameMenu').classList.add('show');
      }else{
        document.getElementById('ingameMenu').classList.remove('show');
        renderer.domElement.requestPointerLock();
      }
      break;
  }
});

document.addEventListener('keyup',(e)=>{
  if(chatOpen||shopOpen||!inGame)return;
  switch(e.code){
    case'KeyW':moveState.forward=0;break;
    case'KeyS':moveState.back=0;break;
    case'KeyA':moveState.left=0;break;
    case'KeyD':moveState.right=0;break;
    case'Space':moveState.jump=false;break;
    case'Tab':document.getElementById('scoreboard').classList.remove('show');break;
  }
});

document.addEventListener('contextmenu',e=>e.preventDefault());

// Mobile controls
function setupMobileControls(){
  const setMove=(btn,state)=>{
    btn.addEventListener('touchstart',(e)=>{e.preventDefault();moveState[state]=1});
    btn.addEventListener('touchend',(e)=>{e.preventDefault();moveState[state]=0});
  };
  setMove(document.getElementById('btnLeft'),'left');
  setMove(document.getElementById('btnRight'),'right');
  setMove(document.getElementById('btnForward'),'forward');
  setMove(document.getElementById('btnBack'),'back');
  
  const btnShoot=document.getElementById('btnShoot');
  btnShoot.addEventListener('touchstart',(e)=>{e.preventDefault();if(isAlive&&!chatOpen&&inGame){shooting=true;tryShoot()}});
  btnShoot.addEventListener('touchend',(e)=>{e.preventDefault();shooting=false});
  
  const btnJump=document.getElementById('btnJump');
  btnJump.addEventListener('touchstart',(e)=>{e.preventDefault();moveState.jump=true});
  btnJump.addEventListener('touchend',(e)=>{e.preventDefault();moveState.jump=false});
  
  document.getElementById('btnReload').addEventListener('touchstart',(e)=>{e.preventDefault();reload()});
  document.getElementById('btnShop').addEventListener('touchstart',(e)=>{e.preventDefault();openShop()});
  
  const touchLook=document.getElementById('touchLook');
  let touchStartX=0,touchStartY=0;
  touchLook.addEventListener('touchstart',(e)=>{
    e.preventDefault();
    if(!inGame||!isAlive||chatOpen)return;
    touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;
  });
  touchLook.addEventListener('touchmove',(e)=>{
    e.preventDefault();
    if(!inGame||!isAlive||chatOpen)return;
    const deltaX=e.touches[0].clientX-touchStartX;
    const deltaY=e.touches[0].clientY-touchStartY;
    const sens=parseFloat(document.getElementById('sensitivity').value)*0.001||0.003;
    yaw+=deltaX*sens;pitch+=deltaY*sens;
    pitch=Math.max(-Math.PI/2+0.01,Math.min(Math.PI/2-0.01,pitch));
    camera.rotation.order='YXZ';camera.rotation.y=-yaw;camera.rotation.x=-pitch;
    touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;
  });
}
setupMobileControls();

console.log('MAXIS STRIKE v5.0 loaded');
</script>
</body>
</html>
